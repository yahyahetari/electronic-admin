// pages/api/analyze-product.js

export default async function handler(req, res) {
    if (req.method !== 'POST') {
        return res.status(405).json({ error: 'Method not allowed' });
    }

    try {
        const { imageUrls, availableProperties, availableTags, categories } = req.body;

        if (!imageUrls || imageUrls.length === 0) {
            return res.status(400).json({ error: 'Image URLs are required' });
        }

        if (!process.env.GEMINI_API_KEY) {
            console.error('âŒ GEMINI_API_KEY is not set');
            return res.status(500).json({ 
                error: 'Server configuration error: API key not found'
            });
        }

        console.log(`ğŸ–¼ï¸ ØªØ­Ù…ÙŠÙ„ ${imageUrls.length} ØµÙˆØ±Ø©...`);

        // ØªØ­Ù…ÙŠÙ„ ÙˆØªØ­ÙˆÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ base64
        const imageParts = [];
        for (let i = 0; i < imageUrls.length; i++) {
            try {
                const imageResponse = await fetch(imageUrls[i]);
                if (!imageResponse.ok) {
                    throw new Error(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ${i + 1}: ${imageResponse.status}`);
                }
                const imageBuffer = await imageResponse.arrayBuffer();
                const base64Image = Buffer.from(imageBuffer).toString('base64');
                
                imageParts.push({
                    inline_data: {
                        mime_type: "image/jpeg",
                        data: base64Image,
                    },
                });
                
                console.log(`âœ… ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ${i + 1} Ø¥Ù„Ù‰ base64`);
            } catch (fetchError) {
                console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ${i + 1}:`, fetchError);
                // Ù†ÙƒÙ…Ù„ Ù…Ø¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø£Ø®Ø±Ù‰
            }
        }

        if (imageParts.length === 0) {
            return res.status(400).json({ 
                error: 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ±'
            });
        }

        console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${imageParts.length} ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­`);

        // Ø¨Ù†Ø§Ø¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ¦Ø§Øª (ÙÙ‚Ø· Ø§Ù„ÙØ±Ø¹ÙŠØ©)
        let categoriesText = '';
        if (categories && categories.length > 0) {
            const subCategories = categories.filter(cat => cat.parent);
            
            if (subCategories.length > 0) {
                categoriesText = '\n\n## Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø© (Ø§Ø®ØªØ± Ù…Ù†Ù‡Ø§ ÙÙ‚Ø·):\n';
                subCategories.forEach(cat => {
                    categoriesText += `- ${cat.name}\n`;
                });
                categoriesText += '\nâš ï¸ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± ÙØ¦Ø© ÙØ±Ø¹ÙŠØ© ÙÙ‚Ø·. Ø¥Ø°Ø§ Ù„Ù… ØªØ¬Ø¯ ÙØ¦Ø© Ù…Ù†Ø§Ø³Ø¨Ø©ØŒ Ø§ØªØ±Ùƒ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹.';
            } else {
                categoriesText = '\n\nâš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª ÙØ±Ø¹ÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.';
            }
        }

        // Ø¨Ù†Ø§Ø¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®ØµØ§Ø¦Øµ
        let propertiesText = '';
        if (availableProperties && availableProperties.length > 0) {
            propertiesText = '\n\n## Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…ØªØ§Ø­Ø© (IMPORTANT - Ø§Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ…):\n';
            availableProperties.forEach(prop => {
                propertiesText += `\n**${prop.name}**: Ø§Ø®ØªØ± Ù‚ÙŠÙ…Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù…Ù†: ${prop.values.join(' | ')}\n`;
            });
            propertiesText += '\nâš ï¸ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù‚ÙŠÙ…Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† ÙƒÙ„ Ø®Ø§ØµÙŠØ©. Ù„Ø§ ØªØªØ±Ùƒ Ø£ÙŠ Ø®Ø§ØµÙŠØ© ÙØ§Ø±ØºØ©.';
        }

        // Ø¨Ù†Ø§Ø¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
        let tagsText = '';
        if (availableTags && availableTags.length > 0) {
            tagsText = `\n\n## Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©:\n${availableTags.join(' | ')}\n`;
            tagsText += '\nØ§Ø®ØªØ± Ù…Ù† 4-8 Ø¹Ù„Ø§Ù…Ø§Øª Ù…Ù†Ø§Ø³Ø¨Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¹Ù„Ø§Ù‡ ÙÙ‚Ø·.';
        }

        const prompt = `Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ ØªØ­Ù„ÙŠÙ„ ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª. Ù„Ø¯ÙŠÙƒ ${imageParts.length} ØµÙˆØ±Ø© Ù„Ù„Ù…Ù†ØªØ¬.

## Ù…Ù‡Ù…ØªÙƒ:
1. **ØªØ­Ù„ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± Ø¨Ø¹Ù†Ø§ÙŠØ©** Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© ÙÙŠ ÙƒÙ„ ØµÙˆØ±Ø©
2. **Ø§Ø³ØªØ®Ø±Ø¬ ÙÙ‚Ø· Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ø§Ù„ÙˆØ§Ø¶Ø­Ø©** ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬ Ù†ÙØ³Ù‡ (Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ù‚Ù…Ø§Ø´/Ø§Ù„Ù…Ø§Ø¯Ø©)
3. **ØªØ¬Ø§Ù‡Ù„ ØªÙ…Ø§Ù…Ø§Ù‹**: Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©ØŒ Ø§Ù„Ø£Ø²Ø±Ø§Ø±ØŒ Ø§Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§ØªØŒ Ø§Ù„Ø®Ù„ÙÙŠØ©ØŒ Ø£Ùˆ Ø§Ù„Ø¸Ù„Ø§Ù„
4. **Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± Ø¨Ù†ÙØ³ Ø§Ù„Ù„ÙˆÙ†** - Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ù„ÙˆÙ† Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
5. **Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØºÙŠØ±Ø§Øª Ù…Ù†ÙØµÙ„Ø© Ù„ÙƒÙ„ Ù„ÙˆÙ† Ù…Ø®ØªÙ„Ù** Ù…Ø¹ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø®ØµØ§Ø¦Øµ (Ù…Ø«Ù„ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª)

${categoriesText}
${propertiesText}
${tagsText}

## Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:

1. **Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (name)**: Ø§Ø³Ù… ÙˆØ§Ø¶Ø­ ÙˆÙˆØµÙÙŠ. Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù„ÙˆÙ† ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·ØŒ Ø§Ø°ÙƒØ±Ù‡ ÙÙŠ Ø§Ù„Ø§Ø³Ù… (Ù…Ø«Ù„: "Ø¨Ø¯Ù„Ø© Ø±Ø³Ù…ÙŠØ© Ø±Ø¬Ø§Ù„ÙŠØ© Ø³ÙˆØ¯Ø§Ø¡"). Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¹Ø¯Ø© Ø£Ù„ÙˆØ§Ù†ØŒ Ù„Ø§ ØªØ°ÙƒØ± Ø§Ù„Ù„ÙˆÙ† (Ù…Ø«Ù„: "Ù‚Ù…ÙŠØµ Ø³ÙØ§Ø±ÙŠ Ø±Ø¬Ø§Ù„ÙŠ")

2. **Ø§Ù„ÙˆØµÙ (description)**: ÙˆØµÙ ØªØ³ÙˆÙŠÙ‚ÙŠ Ø¬Ø°Ø§Ø¨ ÙŠØªÙƒÙˆÙ† Ù…Ù† 7-9 Ø¬Ù…Ù„ ÙŠØ´Ù…Ù„:
   - ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆÙ…Ù…ÙŠØ²Ø§ØªÙ‡
   - Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø¬ÙˆØ¯Ø©
   - Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
   - Ø§Ù„Ø±Ø§Ø­Ø© ÙˆØ§Ù„Ø£Ù†Ø§Ù‚Ø©
   - Ø°ÙƒØ± ØªÙˆÙØ± Ø§Ù„ÙˆØ§Ù† Ù…ØªØ¹Ø¯Ø¯Ø©

3. **Ø§Ù„ÙØ¦Ø© (category)**: Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø§Ù„Ø£Ø¯Ù‚ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¹Ù„Ø§Ù‡ (Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø³Ù… ÙƒÙ…Ø§ Ù‡Ùˆ Ø¨Ø§Ù„Ø¶Ø¨Ø·). Ø¥Ø°Ø§ Ù„Ù… ØªØ¬Ø¯ ÙØ¦Ø© ÙØ±Ø¹ÙŠØ© Ù…Ù†Ø§Ø³Ø¨Ø©ØŒ Ø§ØªØ±Ùƒ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹ Ø£Ùˆ Ø¶Ø¹ null.

4. **Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ÙƒØªØ´ÙØ© (colorsDetected)**: 
   - Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© **Ø§Ù„ÙØ¹Ù„ÙŠØ©** Ø§Ù„ØªÙŠ Ø¸Ù‡Ø±Øª ÙÙŠ Ø§Ù„ØµÙˆØ±
   - **ÙÙ‚Ø· Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…Ù†ØªØ¬** (Ù„ÙˆÙ† Ø§Ù„Ù‚Ù…Ø§Ø´/Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©)
   - ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©ØŒ Ø§Ù„Ø£Ø²Ø±Ø§Ø±ØŒ Ø§Ù„Ø®ÙŠØ§Ø·Ø©ØŒ Ø§Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª
   - Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± Ø¨Ù†ÙØ³ Ø§Ù„Ù„ÙˆÙ†ØŒ Ø¶Ø¹ Ù„ÙˆÙ† ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
   - Ù…Ø«Ø§Ù„ ØµØ­ÙŠØ­: ["Ø£Ø³ÙˆØ¯"] Ø¥Ø°Ø§ ÙƒÙ„ Ø§Ù„ØµÙˆØ± Ø¨Ø¯Ù„Ø© Ø³ÙˆØ¯Ø§Ø¡
   - Ù…Ø«Ø§Ù„ Ø®Ø§Ø·Ø¦: ["Ø£Ø³ÙˆØ¯", "Ø£Ø¨ÙŠØ¶", "Ø±Ù…Ø§Ø¯ÙŠ"] Ù„Ù„Ù…Ù†ØªØ¬ Ù†ÙØ³Ù‡
   - Ø§Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ Ø®Ø§ØµÙŠØ© "Ø§Ù„Ù„ÙˆÙ†" Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¹Ù„Ø§Ù‡

5. **Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª (variants)**: 
   - **Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹**: Ø£Ù†Ø´Ø¦ Ù…ØªØºÙŠØ±Ø§Øª ÙÙ‚Ø· Ù„Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ÙƒØªØ´ÙØ© ÙØ¹Ù„ÙŠØ§Ù‹
   - **Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„ÙˆÙ† ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·**: Ø£Ù†Ø´Ø¦ Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„Ù…Ù‚Ø§Ø³Ø§Øª ÙÙ‚Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù„ÙˆÙ†
   - **Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ø¯Ø© Ø£Ù„ÙˆØ§Ù†**: Ø£Ù†Ø´Ø¦ Ù…ØªØºÙŠØ±Ø§Øª Ù„ÙƒÙ„ Ù„ÙˆÙ† Ã— ÙƒÙ„ Ù…Ù‚Ø§Ø³
   
   Ù…Ø«Ø§Ù„ 1 - Ù…Ù†ØªØ¬ Ø¨Ù„ÙˆÙ† ÙˆØ§Ø­Ø¯ (Ø£Ø³ÙˆØ¯) Ùˆ 5 Ù…Ù‚Ø§Ø³Ø§Øª:
   [
     {"properties": [{"name": "Ø§Ù„Ù„ÙˆÙ†", "value": "Ø£Ø³ÙˆØ¯"}, {"name": "Ø§Ù„Ù…Ù‚Ø§Ø³", "value": "S"}], "price": 150, "cost": 90, "stock": 10},
     {"properties": [{"name": "Ø§Ù„Ù„ÙˆÙ†", "value": "Ø£Ø³ÙˆØ¯"}, {"name": "Ø§Ù„Ù…Ù‚Ø§Ø³", "value": "M"}], "price": 150, "cost": 90, "stock": 10},
     {"properties": [{"name": "Ø§Ù„Ù„ÙˆÙ†", "value": "Ø£Ø³ÙˆØ¯"}, {"name": "Ø§Ù„Ù…Ù‚Ø§Ø³", "value": "L"}], "price": 150, "cost": 90, "stock": 10},
     {"properties": [{"name": "Ø§Ù„Ù„ÙˆÙ†", "value": "Ø£Ø³ÙˆØ¯"}, {"name": "Ø§Ù„Ù…Ù‚Ø§Ø³", "value": "XL"}], "price": 150, "cost": 90, "stock": 10},
     {"properties": [{"name": "Ø§Ù„Ù„ÙˆÙ†", "value": "Ø£Ø³ÙˆØ¯"}, {"name": "Ø§Ù„Ù…Ù‚Ø§Ø³", "value": "XXL"}], "price": 150, "cost": 90, "stock": 10}
   ]
   
   Ù…Ø«Ø§Ù„ 2 - Ù…Ù†ØªØ¬ Ø¨Ù€ 3 Ø£Ù„ÙˆØ§Ù† (Ø£Ø¨ÙŠØ¶ØŒ Ø£Ø²Ø±Ù‚ØŒ Ø£Ø³ÙˆØ¯) Ùˆ 3 Ù…Ù‚Ø§Ø³Ø§Øª:
   [
     {"properties": [{"name": "Ø§Ù„Ù„ÙˆÙ†", "value": "Ø£Ø¨ÙŠØ¶"}, {"name": "Ø§Ù„Ù…Ù‚Ø§Ø³", "value": "M"}], "price": 150, "cost": 90, "stock": 10},
     {"properties": [{"name": "Ø§Ù„Ù„ÙˆÙ†", "value": "Ø£Ø¨ÙŠØ¶"}, {"name": "Ø§Ù„Ù…Ù‚Ø§Ø³", "value": "L"}], "price": 150, "cost": 90, "stock": 10},
     {"properties": [{"name": "Ø§Ù„Ù„ÙˆÙ†", "value": "Ø£Ø¨ÙŠØ¶"}, {"name": "Ø§Ù„Ù…Ù‚Ø§Ø³", "value": "XL"}], "price": 150, "cost": 90, "stock": 10},
     {"properties": [{"name": "Ø§Ù„Ù„ÙˆÙ†", "value": "Ø£Ø²Ø±Ù‚"}, {"name": "Ø§Ù„Ù…Ù‚Ø§Ø³", "value": "M"}], "price": 150, "cost": 90, "stock": 10},
     {"properties": [{"name": "Ø§Ù„Ù„ÙˆÙ†", "value": "Ø£Ø²Ø±Ù‚"}, {"name": "Ø§Ù„Ù…Ù‚Ø§Ø³", "value": "L"}], "price": 150, "cost": 90, "stock": 10},
     {"properties": [{"name": "Ø§Ù„Ù„ÙˆÙ†", "value": "Ø£Ø²Ø±Ù‚"}, {"name": "Ø§Ù„Ù…Ù‚Ø§Ø³", "value": "XL"}], "price": 150, "cost": 90, "stock": 10},
     {"properties": [{"name": "Ø§Ù„Ù„ÙˆÙ†", "value": "Ø£Ø³ÙˆØ¯"}, {"name": "Ø§Ù„Ù…Ù‚Ø§Ø³", "value": "M"}], "price": 150, "cost": 90, "stock": 10},
     {"properties": [{"name": "Ø§Ù„Ù„ÙˆÙ†", "value": "Ø£Ø³ÙˆØ¯"}, {"name": "Ø§Ù„Ù…Ù‚Ø§Ø³", "value": "L"}], "price": 150, "cost": 90, "stock": 10},
     {"properties": [{"name": "Ø§Ù„Ù„ÙˆÙ†", "value": "Ø£Ø³ÙˆØ¯"}, {"name": "Ø§Ù„Ù…Ù‚Ø§Ø³", "value": "XL"}], "price": 150, "cost": 90, "stock": 10}
   ]

6. **Ø§Ù„Ø³Ø¹Ø± (price)**: 
   - Ù‚Ø¯Ù‘Ø± Ø³Ø¹Ø± Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ (Ù†ÙØ³ Ø§Ù„Ø³Ø¹Ø± Ù„ÙƒÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª)
   - Ù„Ù„Ù…Ù„Ø§Ø¨Ø³ Ø§Ù„Ø±Ø¬Ø§Ù„ÙŠØ© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©: 50-200 Ø±ÙŠØ§Ù„
   - Ù„Ù„Ù…Ù„Ø§Ø¨Ø³ Ø§Ù„ÙØ§Ø®Ø±Ø© Ø£Ùˆ Ø§Ù„Ø±Ø³Ù…ÙŠØ©: 150-500 Ø±ÙŠØ§Ù„
   - Ù„Ù„Ù…Ù„Ø§Ø¨Ø³ Ø§Ù„Ø£Ø·ÙØ§Ù„: 30-150 Ø±ÙŠØ§Ù„

7. **Ø§Ù„ØªÙƒÙ„ÙØ© (cost)**: 
   - ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 50-60% Ù…Ù† Ø§Ù„Ø³Ø¹Ø± (Ù†ÙØ³ Ø§Ù„ØªÙƒÙ„ÙØ© Ù„ÙƒÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª)
   - Ù…Ø«Ø§Ù„: Ø¥Ø°Ø§ Ø§Ù„Ø³Ø¹Ø± 100 Ø±ÙŠØ§Ù„ØŒ Ø§Ù„ØªÙƒÙ„ÙØ© ØªÙƒÙˆÙ† 50-60 Ø±ÙŠØ§Ù„

8. **Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (stock)**: ÙˆØ²Ù‘Ø¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ

9. **Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª (tags)**: Ø§Ø®ØªØ± 5-7 Ø¹Ù„Ø§Ù…Ø§Øª Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙ‚Ø·

## ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø­Ø§Ø³Ù…Ø©:
- **Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…Ù†ØªØ¬ ÙÙ‚Ø·** - Ù„ÙˆÙ† Ø§Ù„Ù‚Ù…Ø§Ø´/Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
- **Ù„Ø§ ØªØ¶Ù Ø£Ù„ÙˆØ§Ù† ÙˆÙ‡Ù…ÙŠØ©** - Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙƒÙ„ Ø§Ù„ØµÙˆØ± Ø¨Ù†ÙØ³ Ø§Ù„Ù„ÙˆÙ†ØŒ ÙŠØ¹Ù†ÙŠ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù„ÙˆÙ† ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
- **ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©**: Ø§Ù„Ø£Ø²Ø±Ø§Ø±ØŒ Ø§Ù„Ø¨Ø·Ø§Ù†Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©ØŒ Ø§Ù„Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§ØªØŒ Ø§Ù„Ø®ÙŠØ§Ø·Ø©ØŒ Ø§Ù„Ø®Ù„ÙÙŠØ©
- Ø§Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© "Ø§Ù„Ù„ÙˆÙ†" Ø£Ø¹Ù„Ø§Ù‡
- Ù„Ø§ ØªØ®ØªØ±Ø¹ Ù‚ÙŠÙ… Ø¬Ø¯ÙŠØ¯Ø©
- **Ø£Ù†Ø´Ø¦ Ù…ØªØºÙŠØ±Ø§Øª ÙÙ‚Ø· Ù„Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ÙƒØªØ´ÙØ© Ã— Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª**
- ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø¨Ù†ÙØ³ Ø§Ù„Ø³Ø¹Ø± ÙˆÙ†ÙØ³ Ø§Ù„ØªÙƒÙ„ÙØ©
- ÙˆØ²Ù‘Ø¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
- Ø§Ø®ØªØ± ÙØ¦Ø© ÙØ±Ø¹ÙŠØ© ÙÙ‚Ø·ØŒ ÙˆÙ„ÙŠØ³ ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ©

Ø£Ø¹Ø·Ù†ÙŠ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨ØµÙŠØºØ© JSON ÙÙ‚Ø·ØŒ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù†Øµ Ù‚Ø¨Ù„ Ø£Ùˆ Ø¨Ø¹Ø¯:

{
  "name": "Ø¨Ø¯Ù„Ø© Ø±Ø³Ù…ÙŠØ© Ø±Ø¬Ø§Ù„ÙŠØ© Ø³ÙˆØ¯Ø§Ø¡" (Ø¥Ø°Ø§ Ù„ÙˆÙ† ÙˆØ§Ø­Ø¯) Ø£Ùˆ "Ù‚Ù…ÙŠØµ Ø±Ø¬Ø§Ù„ÙŠ" (Ø¥Ø°Ø§ Ø¹Ø¯Ø© Ø£Ù„ÙˆØ§Ù†),
  "description": "ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ø¬Ø°Ø§Ø¨ Ù„Ù„Ù…Ù†ØªØ¬...",
  "category": "Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø¨Ø§Ù„Ø¶Ø¨Ø· Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ null",
  "colorsDetected": ["Ø£Ø³ÙˆØ¯"] (ÙÙ‚Ø· Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø§Ù„Ù…Ø±Ø¦ÙŠØ©),
  "variants": [
    {
      "properties": [
        {"name": "Ø§Ù„Ù„ÙˆÙ†", "value": "Ø£Ø³ÙˆØ¯"},
        {"name": "Ø§Ù„Ù…Ù‚Ø§Ø³", "value": "M"}
      ],
      "price": 150,
      "cost": 90,
      "stock": 10
    }
    // ... Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ù„ÙƒÙ„ Ù„ÙˆÙ† Ù…ÙƒØªØ´Ù ÙØ¹Ù„ÙŠØ§Ù‹
  ],
  "tags": ["Ø¹Ù„Ø§Ù…Ø©1", "Ø¹Ù„Ø§Ù…Ø©2", "Ø¹Ù„Ø§Ù…Ø©3"]
}`;

        console.log('ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Gemini API Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ±...');

        // Ø¨Ù†Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ±
        const contentParts = [
            { text: prompt },
            ...imageParts
        ];

        const geminiResponse = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${process.env.GEMINI_API_KEY}`,
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [
                        {
                            parts: contentParts,
                        },
                    ],
                    generationConfig: {
                        temperature: 0.3,
                        topK: 30,
                        topP: 0.85,
                        maxOutputTokens: 4096,
                    },
                }),
            }
        );

        if (!geminiResponse.ok) {
            const errorData = await geminiResponse.json();
            console.error('âŒ Gemini API Error:', errorData);
            return res.status(500).json({ 
                error: 'ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ù…Ø¹ Gemini',
                details: errorData
            });
        }

        const data = await geminiResponse.json();
        console.log('âœ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø¯ Ù…Ù† Gemini');

        if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
            console.error('âŒ Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©:', data);
            return res.status(500).json({ 
                error: 'Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ù…Ù† Gemini'
            });
        }

        const text = data.candidates[0].content.parts[0].text;
        console.log('ğŸ“ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªÙ„Ù…:', text.substring(0, 500) + '...');
        
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ JSON
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
            try {
                const productData = JSON.parse(jsonMatch[0]);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (!productData.variants || productData.variants.length === 0) {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØºÙŠØ± Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØºÙŠØ±Ø§Øª
                    productData.variants = [{
                        properties: productData.properties || [],
                        price: productData.price || 100,
                        cost: productData.cost || 60,
                        stock: productData.stock || 50
                    }];
                }
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù‚ÙŠÙ… ØµØ­ÙŠØ­Ø© Ù„Ù„Ù…ØªØºÙŠØ±Ø§Øª
                productData.variants = productData.variants.map(variant => ({
                    ...variant,
                    price: Number(variant.price) || 100,
                    cost: Number(variant.cost) || 60,
                    stock: Number(variant.stock) || 10
                }));
                
                console.log('âœ… ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                console.log(`ğŸ¨ Ø£Ù„ÙˆØ§Ù† Ù…ÙƒØªØ´ÙØ©: ${productData.colorsDetected?.length || 0}`);
                console.log(`ğŸ“¦ Ù…ØªØºÙŠØ±Ø§Øª ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§: ${productData.variants.length}`);
                
                return res.status(200).json(productData);
            } catch (parseError) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ JSON:', parseError);
                return res.status(500).json({ 
                    error: 'ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ JSON Ù…Ù† Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ',
                    rawText: text.substring(0, 1000)
                });
            }
        } else {
            console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ JSON');
            return res.status(500).json({ 
                error: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ JSON ÙÙŠ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ',
                rawText: text.substring(0, 1000)
            });
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ Ø¹Ø§Ù…:', error);
        return res.status(500).json({ 
            error: 'Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…',
            message: error.message
        });
    }
}